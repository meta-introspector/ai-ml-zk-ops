# User Guide: `tracenix` Command

## Introduction

The `tracenix` command is a specialized tool within the `pick-up-nix` project designed to trace the system calls and events generated by Nix commands. It leverages an integrated `strace`-like generator to capture low-level interactions, providing insights into how Nix operates at the system level. This is particularly useful for debugging, performance analysis, and understanding the underlying behavior of Nix expressions and operations.

## Purpose

`tracenix` aims to help users:

*   **Debug Nix Issues:** Understand why a Nix build or command might be failing by observing its system interactions.
*   **Analyze Performance:** Identify bottlenecks or unexpected system calls during Nix operations.
*   **Gain Deep Insight:** See the exact files accessed, network connections made, and processes spawned by Nix.

## Usage

The `tracenix` command is executed via `cargo run` from the root of the `pick-up-nix` project. You pass the Nix command and its arguments directly after `--`.

### Basic Syntax

```bash
cargo run -- tracenix -- <NIX_COMMAND> [NIX_ARGUMENTS...]
```

*   `<NIX_COMMAND>`: The Nix subcommand you want to trace (e.g., `build`, `shell`, `flake check`, `--version`).
*   `[NIX_ARGUMENTS...]`: Any arguments you would normally pass to the Nix subcommand.

### Examples

1.  **Trace `nix --version`:**
    ```bash
cargo run -- tracenix -- --version
    ```
    This will execute `nix --version` and capture all system calls made during its execution.

2.  **Trace a dry run of `nix build`:**
    ```bash
cargo run -- tracenix -- build --dry-run
    ```
    This is useful for seeing what files and processes a build would interact with without actually performing the build.

3.  **Trace `nix flake check` for a specific path:**
    ```bash
cargo run -- tracenix -- flake check /path/to/your/flake
    ```

## Output

Upon execution, `tracenix` will output:

*   **Standard Output/Error of the Traced Nix Command:** You will see the normal output of the Nix command you are tracing.
*   **Tracing Information:** `tracenix` will print messages indicating that it's tracing the command.
*   **System Event Summary:** After the Nix command completes, `tracenix` will report the total number of system events captured, e.g., "Captured X system events."

Currently, the detailed system events are processed internally. Future versions will allow for more detailed output or integration with eBPF analysis tools.

## Troubleshooting

*   **"Failed to spawn command" or similar errors:** Ensure that `nix` is installed and accessible in your system's PATH.
*   **No system events captured:** This might indicate an issue with the `strace` generator integration or that the traced command completed too quickly to capture events. Verify your `pick-up-nix` project is correctly built.
*   **Compilation errors:** If you encounter Rust compilation errors, ensure all dependencies are correctly specified in `Cargo.toml` and run `cargo clean && cargo build`.

## Future Enhancements

As outlined in the project's CRQ, future enhancements include:

*   Detailed output of captured `SystemEvent` data.
*   Integration with a userspace eBPF runtime for advanced analysis.
*   More sophisticated filtering and aggregation of events.
