# SOP: Restoring Deleted Files in Git Submodules

## 1. Purpose

This Standard Operating Procedure (SOP) outlines the steps to restore files that have been marked as 'deleted' and staged for commit within Git submodules. This process is crucial for recovering inadvertently deleted files or reverting changes that were not intended to be permanent deletions.

## 2. Prerequisites

Before proceeding with this SOP, ensure the following:

*   **`submodules_status.txt` file**: A status report of all submodules, typically generated by a script that runs `git status` within each submodule. This file is used by the restoration script to identify affected submodules. The expected path for this file is `index/submodules_status.txt` relative to the project root.
*   **`restore_deleted_submodule_files.sh` script**: The script used to automate the restoration process. This script should be located at `scripts/restore_deleted_submodule_files.sh` relative to the project root and must be executable (`chmod +x`).

## 3. Procedure

Follow these steps to restore deleted files in submodules:

### 3.1. Review the `submodules_status.txt`

Examine the `index/submodules_status.txt` file to understand which submodules have staged deletions. Look for lines containing `deleted:` under each `Entering 'submodule/path'` section.

### 3.2. Perform a Dry Run (Recommended)

It is highly recommended to perform a dry run first to see which commands will be executed without making any actual changes.

1.  Open the `scripts/restore_deleted_submodule_files.sh` script.
2.  Ensure the `DRY_RUN` variable at the top of the script is set to `true`:
    ```bash
    DRY_RUN=true
    ```
3.  Save the script.
4.  Execute the script from the project root directory:
    ```bash
    ./scripts/restore_deleted_submodule_files.sh
    ```
5.  Review the output. The script will print messages indicating which submodules it would process and the `git restore --staged .` and `git checkout .` commands it would run.

### 3.3. Execute the Restoration

Once you are satisfied with the dry run output, proceed with the actual restoration:

1.  Open the `scripts/restore_deleted_submodule_files.sh` script.
2.  Set the `DRY_RUN` variable to `false`:
    ```bash
    DRY_RUN=false
    ```
3.  Save the script.
4.  Execute the script from the project root directory:
    ```bash
    ./scripts/restore_deleted_submodule_files.sh
    ```
    The script will now execute the `git restore --staged .` and `git checkout .` commands within each identified submodule, effectively unstaging the deletions and restoring the files to their previous state.

## 4. Verification

After the restoration process is complete, verify that the files have been restored correctly:

1.  **Check `git status` in the main repository**: Run `git status` in the main project root. You should no longer see "deleted" files staged for commit within the affected submodules. Instead, you might see them as "modified" if there were other changes, or they might be clean.
2.  **Check `git status` within affected submodules**: Navigate into each submodule directory that was processed and run `git status`. The output should indicate that the working tree is clean or show any other legitimate modifications, but not staged deletions.
3.  **Inspect files**: Manually check some of the files that were previously marked as deleted to ensure their content has been restored as expected.

## 5. Troubleshooting

*   **Script not found/executable:** Ensure the path to `restore_deleted_submodule_files.sh` is correct and that it has execute permissions (`chmod +x scripts/restore_deleted_submodule_files.sh`).
*   **Script errors**: If the `restore_deleted_submodule_files.sh` script itself is failing, ensure it passes `shellcheck`. Refer to [Memo: Use Shellcheck Always After Changes](docs/memos/Shellcheck_Always_After_Changes.md) for details.

## 6. Related Documents

*   [CRQ-016: Submodule Nixification and Flake Refactoring](docs/crqs/CRQ_016_Submodule_Nixification.md)
*   [Memo: Use Shellcheck Always After Changes](docs/memos/Shellcheck_Always_After_Changes.md)
