# SOP: Nix Graph Analysis and Reporting

## 1. Purpose

This Standard Operating Procedure (SOP) outlines the process for analyzing the Nix dependency graph data generated by `nixtract` and creating comprehensive reports. The goal is to derive insights into project dependencies, identify potential optimizations, and ensure a clear understanding of the Nix ecosystem within the project.

## 2. Scope

This SOP applies to anyone responsible for understanding, visualizing, or reporting on the Nix dependency structure of the project.

## 3. Prerequisites

*   A `derivations.jsonl` file generated using `nixtract` (as per `SOP_Nixtract_Usage.md`).
*   `jq` installed for parsing and querying JSON data.
*   (Optional) Graph visualization tools (e.g., Graphviz, online JSON to Graphviz converters) for visual representation.

## 4. Procedure: Analyzing and Reporting on Nix Graphs

### 4.1. Understanding `derivations.jsonl`

The `derivations.jsonl` file is a JSON Lines file, where each line is a JSON object representing a Nix derivation. Key fields to analyze include:

*   `drv_path`: The path to the derivation in the Nix store.
*   `attribute_path`: The attribute path used to refer to this derivation in the flake.
*   `name`: The name of the package or component.
*   `version`: The version of the package.
*   `dependencies`: A list of other derivations that this derivation depends on.
*   `build_inputs`, `propagated_build_inputs`, `native_build_inputs`: Specific types of dependencies.

### 4.2. Basic Analysis with `jq`

`jq` is a powerful command-line JSON processor that can be used to extract, filter, and transform the data in `derivations.jsonl`.

*   **Count total derivations:**
    ```bash
    cat derivations.jsonl | wc -l
    ```
*   **List all unique package names:**
    ```bash
    cat derivations.jsonl | jq -r '.name' | sort -u
    ```
*   **Find derivations with a specific dependency (e.g., `nixpkgs`):**
    ```bash
    cat derivations.jsonl | jq 'select(.dependencies[] | contains("nixpkgs"))'
    ```
*   **Extract direct dependencies of a specific package (e.g., `myPackage`):**
    ```bash
    cat derivations.jsonl | jq 'select(.name == "myPackage") | .dependencies'
    ```

### 4.3. Generating Visualizations (Optional)

For complex graphs, a visual representation can be highly beneficial. This typically involves converting the `derivations.jsonl` data into a format suitable for graph visualization tools (e.g., DOT format for Graphviz).

*   **Conceptual Steps:**
    1.  Parse `derivations.jsonl` to extract nodes (derivations) and edges (dependencies).
    2.  Format this data into a DOT language string.
    3.  Use Graphviz (`dot` command) to render the DOT string into an image (e.g., SVG, PNG).

    *(Note: A dedicated script or tool might be developed for this conversion if needed, as `jq` alone can be complex for full DOT generation.)*

### 4.4. Creating a Report

Compile the findings from the analysis into a human-readable report. The report should include:

*   **Summary:** Overview of the Nix ecosystem, key dependencies, and any identified issues or optimizations.
*   **Key Metrics:** Number of derivations, unique packages, average dependency depth, etc.
*   **Insights:** Observations about the graph structure, potential for deduplication, or areas for refactoring.
*   **Recommendations:** Actionable steps based on the insights (e.g., update specific dependencies, refactor certain flakes).
*   **Visualizations (if generated):** Include relevant graph diagrams.

## 5. Troubleshooting

*   **`jq` errors:** Ensure your `jq` queries are syntactically correct and match the structure of the `derivations.jsonl` output.
*   **Large `derivations.jsonl` file:** Use `head`, `tail`, and `grep` to inspect parts of the file before running complex `jq` queries.

## 6. Related Documentation

*   [CRQ-016: Submodule Nixification and Flake Refactoring](docs/crqs/CRQ_016_Submodule_Nixification.md)
*   [Memo: Use Shellcheck Always After Changes](docs/memos/Shellcheck_Always_After_Changes.md)
*   [SOP: Nixtract Usage and Graph Generation](docs/sops/SOP_Nixtract_Usage.md)
*   [CRQ-001: Nix Package Indexing and Reporting](docs/crqs/CRQ_001_Nix_Package_Indexing_and_Reporting.md)
*   [CRQ-002: Nixtract Integration and Quality](docs/crqs/CRQ_002_Nixtract_Integration_and_Quality.md)
