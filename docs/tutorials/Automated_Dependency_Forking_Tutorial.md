# Tutorial: Automated GitHub Dependency Forking

This tutorial guides you through the use of the `automate_dependency_forking.sh` script, which automates the process of identifying external GitHub Nix flake dependencies and forking them into the `meta-introspector` GitHub organization.

## 1. Purpose

The `automate_dependency_forking.sh` script helps mitigate supply chain risks and improves local development robustness by ensuring that all external GitHub dependencies used in your Nix flakes are mirrored under the `meta-introspector` GitHub organization. This provides a controlled and stable source for these dependencies.

## 2. Prerequisites

*   **GitHub CLI (`gh`)**: The GitHub Command Line Interface must be installed and authenticated with sufficient permissions to fork repositories under the `meta-introspector` organization. You can authenticate using `gh auth login`.
*   **`jq`**: A lightweight and flexible command-line JSON processor.
*   **`index/file_nix.txt`**: This file, generated by `update_index.sh`, lists all `flake.nix` files in the project.
*   **Project Root**: You should execute the script from the root directory of your `pick-up-nix` project.

## 3. How the Script Works

The script performs the following steps:

1.  **Lists `meta-introspector` Repositories**: It uses `gh repo list meta-introspector` to get a current list of all repositories within the `meta-introspector` GitHub organization and saves this information to `index/github_meta-introspector_repos.json`.
2.  **Identifies GitHub Dependencies**: It reads all `flake.nix` files (listed in `index/file_nix.txt`) and extracts all `github:`-prefixed dependencies.
3.  **Checks for Existing Forks**: For each identified `github:` dependency, it checks if a repository with the same name already exists under the `meta-introspector` organization.
4.  **Forks Missing Dependencies**: If a dependency is found that does not have a corresponding fork in `meta-introspector`, the script will use `gh repo fork` to create a new fork of the original repository into the `meta-introspector` organization.

## 4. Usage

### 4.1. Dry Run (Report Mode)

It is highly recommended to first run the script in report mode to see which dependencies would be forked without actually performing any changes.

```bash
./scripts/automate_dependency_forking.sh --report
```

**Expected Output (example):**

```
[YYYY-MM-DD HH:MM:SS] Running in REPORT mode (dry-run).
[YYYY-MM-DD HH:MM:SS] Listing repositories in meta-introspector organization...
[YYYY-MM-DD HH:MM:SS] Repository list saved to index/github_meta-introspector_repos.json
[YYYY-MM-DD HH:MM:SS] Identifying GitHub dependencies from flake.nix files...
[YYYY-MM-DD HH:MM:SS] Found X unique GitHub dependencies.
[YYYY-MM-DD HH:MM:SS] Processing dependency: owner/repo1
[YYYY-MM-DD HH:MM:SS]   Fork 'meta-introspector/repo1' already exists. Skipping.
[YYYY-MM-DD HH:MM:SS] Processing dependency: owner/repo2
[YYYY-MM-DD HH:MM:SS]   Fork 'meta-introspector/repo2' does not exist.
[YYYY-MM-DD HH:MM:SS]   REPORT: Would fork 'owner/repo2' to 'meta-introspector/repo2'.
[YYYY-MM-DD HH:MM:SS] Automated dependency forking process complete.
```

### 4.2. Executing the Forking Process

Once you are satisfied with the dry run report, you can execute the script to perform the actual forking.

```bash
./scripts/automate_dependency_forking.sh
```

**Expected Output (example):**

```
[YYYY-MM-DD HH:MM:SS] Listing repositories in meta-introspector organization...
[YYYY-MM-DD HH:MM:SS] Repository list saved to index/github_meta-introspector_repos.json
[YYYY-MM-DD HH:MM:SS] Identifying GitHub dependencies from flake.nix files...
[YYYY-MM-DD HH:MM:SS] Found X unique GitHub dependencies.
[YYYY-MM-DD HH:MM:SS] Processing dependency: owner/repo1
[YYYY-MM-DD HH:MM:SS]   Fork 'meta-introspector/repo1' already exists. Skipping.
[YYYY-MM-DD HH:MM:SS] Processing dependency: owner/repo2
[YYYY-MM-DD HH:MM:SS]   Fork 'meta-introspector/repo2' does not exist.
[YYYY-MM-DD HH:MM:SS]   Attempting to fork 'owner/repo2' to 'meta-introspector/repo2'...
[YYYY-MM-DD HH:MM:SS]   Successfully forked 'owner/repo2' to 'meta-introspector/repo2'.
[YYYY-MM-DD HH:MM:SS] Listing repositories in meta-introspector organization...
[YYYY-MM-DD HH:MM:SS] Repository list saved to index/github_meta-introspector_repos.json
[YYYY-MM-DD HH:MM:SS] Automated dependency forking process complete.
```

## 5. Troubleshooting

*   **`gh` CLI not found or authenticated**: Ensure `gh` is installed and you have logged in with `gh auth login`.
*   **`jq` not found**: Install `jq` using your system's package manager (e.g., `sudo apt install jq` on Debian/Ubuntu, `nix-env -iA nixpkgs.jq` with Nix).
*   **`index/file_nix.txt` not found**: Run `./update_index.sh` from the project root to generate this file.
*   **Forking errors**: Check the output from `gh repo fork` for specific error messages. This could be due to network issues, insufficient permissions, or a repository name conflict.
*   **Script errors**: If the `automate_dependency_forking.sh` script itself is failing, ensure it passes `shellcheck`. Refer to [Memo: Use Shellcheck Always After Changes](docs/memos/Shellcheck_Always_After_Changes.md) for details.

## 6. Related Documents

*   [CRQ-018: Automated GitHub Forking for Nix Flake Dependencies](docs/crqs/CRQ_018_Automated_GitHub_Forking.md)
*   [Memo: Use Shellcheck Always After Changes](docs/memos/Shellcheck_Always_After_Changes.md)
